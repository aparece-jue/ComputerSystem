---
date: 2025-07-02
tags:
---
# 结构与联合
## 结构
- 结构的所有组成部分都存放在内存中的一段连续的区域内，指向结构的指针就是结构的第一个字节的地址。
	- 编译器维护关于每个结构类型的信息，指示每个字段的字节偏移。以偏移作为内存引用指令中的位移，从而产生对结构元素的引用。
- 结构的各个字段的选取是在编译时处理的，机器代码中不包含关于字段声明和字段名字的信息。
## 联合
- 常与枚举类型连用。
## 数据对齐
- 对基础类型的合法地址做了限制，要求某种类型对象的地址必须是某个值K(通常为2、4、8)的倍数。
	- 该限制简化了形成处理器和内存系统之间接口的硬件设计。
	- 因为CPU 总线以块为单位读取内存，非对齐访问可能跨越多个块，从而导致性能下降。
		- 块的大小为总线宽度的整数倍。
- `.align N` 是 **汇编伪指令**。
	- 用于将数据类型对齐到指定位置。
	- `.align N` 会让当前位置向前填充空字节（通常为 0），直到 **地址是 N 的倍数**。
- 对于某些Intel与AMD处理器，若不进行数据对齐，有些多媒体操作的SSE指令无法正确执行。
	- 这些指令必须对16字节数据块进行操作，在SSK单元和内存之间传送数据的指令要求内存地址必须是16的倍数。
	- 任何针对x86-64处理器的编译器和运行时系统都必须保证分配用来保存可能被SSE寄存器读或写的数据结构的内存满足16字节对齐。
		- 任何内存分配函数生成的块的起始地址都必须是16的倍数。
		- 大多数函数的栈帧的边界都必须是16字节的倍数。
			- %rsp（栈指针）在**调用函数，压入返回地址后，必须对齐到 16 字节**。
- 结构体布局优化
	- **可见的行为改变**；
	- 可能引起程序语义差异或二进制不兼容；
	- 编译器不会擅自优化。
### 数据对齐要求
| 数据类型                     | 对齐长度     |
| ------------------------ | -------- |
| `char`                   | 1        |
| `short`                  | 2        |
| `int`,`float`            | 4        |
| `long`,`double`,`char *` | 8        |
| `struct`                 | 最大成员的对齐值 |
- 对齐长度为自身类型大小。